<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Avenues & Dragons — Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%}
body{margin:0;font-family:"Tajawal",sans-serif;background:#000;color:#fff;overflow:hidden}
.bg{position:fixed;inset:0;background:#000 center/cover no-repeat;filter:blur(5px);transform:scale(1.08);opacity:.9;z-index:1}
.card{position:relative;z-index:3;width:92%;max-width:560px;margin:10vh auto 0;padding:20px;text-align:center;
backdrop-filter:blur(6px);background:rgba(10,10,30,.2);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 0 28px rgba(0,0,0,.25)}
h1{font-size:34px;font-weight:800;margin:0 0 10px;text-shadow:0 0 8px rgba(255,255,255,.35)}
#question{font-size:22px;margin:0 0 18px;color:#eee;text-shadow:0 0 6px rgba(0,0,0,.4);line-height:1.5}
.choice{position:relative;background:rgba(20,20,35,.82);border:2px solid #7a5cff;padding:18px;font-size:22px;color:#fff;border-radius:16px;
box-shadow:0 0 18px #7a5cff66,inset 0 0 12px #7a5cff22;margin-bottom:18px}
.sticker{position:absolute;top:-12px;left:-12px;background:rgba(255,255,255,.25);backdrop-filter:blur(6px);padding:6px 12px;border-radius:12px;
font-size:16px;font-weight:800;color:#fff;border:1px solid rgba(255,255,255,.45);box-shadow:0 0 12px rgba(255,255,255,.2);pointer-events:none}
.status{margin-top:8px;font-size:12px;opacity:.8}
.ctrl{position:fixed;right:12px;bottom:12px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);
border-radius:12px;padding:8px 12px;font-weight:800;color:#fff;text-decoration:none;z-index:4}
</style>
<script src="https://js.pusher.com/8.4/pusher.min.js"></script>
</head>
<body>
<div id="bg" class="bg"></div>

<div class="card">
  <h1 id="title">Avenues & Dragons</h1>
  <div id="question">…</div>
  <div class="choice"><div class="sticker">اكتبوا ١</div><span id="c1">…</span></div>
  <div class="choice"><div class="sticker">اكتبوا ٢</div><span id="c2">…</span></div>
  <div id="st" class="status">جاهز</div>
</div>

<a class="ctrl" href="./admin.html">تحكم ⚙️</a>

<script>
const el={t:document.getElementById('title'),q:document.getElementById('question'),
c1:document.getElementById('c1'),c2:document.getElementById('c2'),bg:document.getElementById('bg'),st:document.getElementById('st')};

const qs=new URLSearchParams(location.search);
let DATA_URL = qs.get('data_url') || localStorage.getItem('myjson_data_url') || "";

function apply(d){
  if(!d) return;
  el.t.textContent=d.title||"Avenues & Dragons";
  el.q.textContent=d.question||"…";
  el.c1.textContent=d.choice1||"…";
  el.c2.textContent=d.choice2||"…";
  el.bg.style.backgroundImage=d.bg?`url('${d.bg}')`:"";
}

async function fetchData(){
  if(!DATA_URL){ el.st.textContent="أدخل رابط MyJSON من صفحة التحكم"; return; }
  try{
    // Ensure we always fetch the newest data from MyJSON by adding a unique timestamp
    const r=await fetch(DATA_URL + (DATA_URL.includes('?')?'&':'?') + '_ts=' + Date.now());
    const j=await r.json();
    const d=j && j.data ? j.data : j;
    apply(d||{});
    el.st.textContent="متصل";
  }catch(e){ el.st.textContent="غير متصل"; }
}

// --- PUSHER REAL-TIME LISTENER ---

// 1. Initialize Pusher with your credentials
const PUSHER_KEY = 'e3e71f98de794afeae8e';
const PUSHER_CLUSTER = 'ap2';

const pusher = new Pusher(PUSHER_KEY, {
  cluster: PUSHER_CLUSTER
});

// 2. Subscribe to the control channel (Must match the webhook)
const channel = pusher.subscribe('game-control');

// 3. Bind to the 'scene-updated' event (Must match the webhook)
channel.bind('scene-updated', function(data) {
  const u = localStorage.getItem('myjson_data_url') || DATA_URL;
  if(u && u!==DATA_URL){ DATA_URL=u; } // Check for new URL saved by admin
  
  fetchData(); 
  el.st.textContent = "تم استلام تحديث! جارٍ التحميل..."; 
});


// Initial load
fetchData();
el.st.textContent = "متصل، ينتظر تحديث المدير..."; 
</script>
</body>
</html>
