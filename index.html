<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- =====================================================================================
         Avenues & Dragons - Viewer (Neon) - FULL EXPANDED VERSION (no condensation)
         - First-screen setup (Bin ID + Master Key) fixed for iPhone keyboard + scrolling
         - Same JSONBin polling logic (unchanged)
         - Neon UI + stickers: ÿßŸÉÿ™ÿ®Ÿàÿß Ÿ° / ÿßŸÉÿ™ÿ®Ÿàÿß Ÿ¢ / ÿßŸÉÿ™ÿ®Ÿàÿß Ÿ£ / ÿßŸÉÿ™ÿ®Ÿàÿß Ÿ§
         - Cloudinary looping background video
         ===================================================================================== -->

    <meta charset="UTF-8" />

    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover"
    />

    <title>
        ÿ£ŸÅŸäŸÜŸàÿ≤ ŸàÿßŸÑÿ™ŸÜÿßŸÜŸäŸÜ - Avenues & Dragons
    </title>

    <style>
        /* =================================================================================
           RESET / BASE
           ================================================================================= */

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family:
                "Tajawal",
                system-ui,
                -apple-system,
                Segoe UI,
                Roboto,
                Arial,
                sans-serif;
            background: #000000;
            color: #ffffff;
            overflow: hidden;
        }

        /* =================================================================================
           BACKGROUND VIDEO (Cloudinary)
           - stays behind everything
           - brightness reduced so neon pops
           ================================================================================= */

        #bg-video {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 100vw;
            height: auto;
            transform: translate(-50%, -50%);
            object-fit: contain;
            z-index: -3;
            filter: brightness(58%);
        }

        .vignette {
            position: fixed;
            inset: 0;
            z-index: -2;
            pointer-events: none;
            background:
                radial-gradient(
                    120% 120% at 50% 50%,
                    rgba(0, 0, 0, 0.00) 40%,
                    rgba(0, 0, 0, 0.25) 100%
                );
        }

        /* =================================================================================
           SETUP OVERLAY (FIRST PAGE)
           - Full screen
           - Scrollable container to avoid iPhone keyboard overlap
           - Inputs at 16px to prevent Safari auto-zoom
           - Only UI; does not touch data logic
           ================================================================================= */

        .setup-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.60);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 24px;
        }

        .setup-inner {
            width: min(92vw, 640px);
            max-height: calc(100dvh - 48px);
            overflow: auto;
            border-radius: 20px;
            background: #fff8dc;
            color: #2b2b2b;
            border: 2px solid #ffc107;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.50);
            padding: 22px;
        }

        .setup-title {
            color: #8a6d00;
            font-size: 22px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 10px;
        }

        .setup-desc {
            color: #8a6d00;
            text-align: center;
            margin: 6px 0 12px 0;
            font-size: 14px;
        }

        .setup-label {
            display: block;
            margin-top: 12px;
            margin-bottom: 6px;
            color: #8a6d00;
            font-weight: 700;
        }

        .setup-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #ffc107;
            border-radius: 10px;
            background: #ffffff;
            font-family: monospace;
            font-size: 16px; /* prevents iOS zoom */
        }

        .setup-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .setup-button-save {
            padding: 14px 24px;
            border: 0;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer;
            background: #28a745;
            color: #ffffff;
        }

        .setup-button-reset {
            padding: 14px 24px;
            border: 0;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer;
            background: #eeeeee;
            color: #333333;
        }

        .hidden {
            display: none !important;
        }

        /* =================================================================================
           GAME WRAP + CARD (NEON)
           ================================================================================= */

        .game-wrap {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 24px;
            z-index: 10;
        }

        .card {
            width: min(92vw, 720px);
            background: rgba(10, 10, 16, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 22px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.50),
                inset 0 0 0 1px rgba(255, 255, 255, 0.03);
            padding: 26px 22px 32px;
        }

        .title {
            font-weight: 800;
            letter-spacing: 0.5px;
            font-size: clamp(22px, 5.2vw, 38px);
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #7D5EFF, #9A68FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .question {
            text-align: center;
            color: #d9d9e6;
            font-size: clamp(16px, 4.2vw, 22px);
            margin: 4px auto 18px auto;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes pulse {
            0%   { transform: scale(1.00); }
            50%  { transform: scale(1.05); }
            100% { transform: scale(1.00); }
        }

        .question.updating {
            animation: pulse 0.5s ease;
        }

        /* =================================================================================
           CHOICES + NEON BUTTONS + STICKERS
           ================================================================================= */

        .choices {
            display: grid;
            gap: 16px;
        }

        .choice {
            position: relative;
        }

        .choice.hidden {
            display: none;
        }

        .choice::before {
            content: attr(data-sticker);
            position: absolute;
            top: -10px;
            left: 10px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.16);
            color: #ffffff;
            border-radius: 12px;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            font-weight: 800;
            font-size: 14px;
            line-height: 1;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
            z-index: 1;
        }

        .btn {
            width: 100%;
            border: 0;
            outline: 0;
            border-radius: 18px;
            padding: 18px 20px;
            text-align: center;
            font-weight: 700;
            font-size: clamp(16px, 4.4vw, 22px);
            color: #e9e7ff;
            cursor: default;
            background: linear-gradient(180deg, #0d0d15, #12121c);
            box-shadow:
                0 0 0 1px rgba(125, 94, 255, 0.25) inset,
                0 0 14px rgba(125, 94, 255, 0.45),
                0 0 50px rgba(125, 94, 255, 0.28);
            position: relative;
            transition: all 0.30s ease;
        }

        .btn::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 18px;
            padding: 1px;
            background: linear-gradient(90deg, #7D5EFF, #9A68FF, #7D5EFF);
            -webkit-mask:
                linear-gradient(#000 0 0) content-box,
                linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.90;
        }

        .btn.updating {
            animation: pulse 0.5s ease;
        }

        /* =================================================================================
           STATUS
           ================================================================================= */

        .status {
            text-align: center;
            margin-top: 16px;
            color: #bdb8ff;
            font-size: 14px;
            opacity: 0.85;
            padding: 8px;
            border-radius: 8px;
        }

        .status.connected {
            color: #10b981;
        }

        .status.updating {
            color: #f59e0b;
            font-weight: 600;
        }

        .status.error {
            color: #ef4444;
        }

        /* =================================================================================
           RESPONSIVE TWEAKS
           ================================================================================= */

        @media (max-width: 480px) {
            .choice::before {
                top: -12px;
                left: 8px;
                font-size: 13px;
            }

            .btn {
                padding: 16px 16px;
                border-radius: 16px;
            }

            .btn::after {
                border-radius: 16px;
            }
        }
    </style>
</head>
<body>

    <!-- =================================================================================
         BACKGROUND VIDEO (Cloudinary direct URL)
         ================================================================================= -->
    <video
        id="bg-video"
        autoplay
        muted
        loop
        playsinline
    >
        <source
            src="https://res.cloudinary.com/dkaldddme/video/upload/f_auto,q_auto/v1/copy_CDC85CC8-6581-4C3F-B5E2-46DC4C3A0C86_b2infi.mp4"
            type="video/mp4"
        />
    </video>

    <div
        class="vignette"
        aria-hidden="true"
    ></div>

    <!-- =================================================================================
         FIRST PAGE: SETUP OVERLAY (UI ONLY)
         ================================================================================= -->
    <div
        id="setupOverlay"
        class="setup-overlay"
    >
        <div
            class="setup-inner"
            role="dialog"
            aria-modal="true"
        >
            <div
                class="setup-title"
            >
                ‚öôÔ∏è ÿ•ÿπÿØÿßÿØ ŸÑŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©
            </div>

            <div
                class="setup-desc"
            >
                ÿ£ÿØÿÆŸÑ <strong>Bin ID</strong> Ÿà <strong>Master Key</strong> ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÄ JSONBinÿå ÿ´ŸÖ ÿßÿ∂ÿ∫ÿ∑ ÿ≠ŸÅÿ∏.
            </div>

            <label
                class="setup-label"
                for="binIdInput"
            >
                Bin ID
            </label>

            <input
                id="binIdInput"
                class="setup-input"
                placeholder="ŸÖÿ´ÿßŸÑ: 66xxxx..."
                inputmode="text"
                autocomplete="off"
            />

            <label
                class="setup-label"
                for="apiKeyInput"
            >
                API Key (Master Key)
            </label>

            <input
                id="apiKeyInput"
                class="setup-input"
                placeholder="ÿßÿ®ÿØÿ£ ÿ®ŸÄ $2b$..."
                inputmode="text"
                autocomplete="off"
            />

            <div
                class="setup-actions"
            >
                <button
                    id="saveSetupBtn"
                    class="setup-button-save"
                    type="button"
                >
                    ‚úÖ ÿ≠ŸÅÿ∏ ŸàÿßŸÑÿ®ÿØÿ°
                </button>

                <button
                    id="resetSetupBtn"
                    class="setup-button-reset"
                    type="button"
                >
                    ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ
                </button>
            </div>
        </div>
    </div>

    <!-- =================================================================================
         VIEWER CARD (NEON) ‚Äî GAME UI
         ================================================================================= -->
    <div
        class="game-wrap"
    >
        <div
            class="card"
        >
            <div
                class="title"
                id="title"
            >
                Avenues & Dragons
            </div>

            <div
                id="question"
                class="question"
            >
                ÿßŸÜÿ™ÿ∏ÿ± ÿßŸÑÿ≥ÿ§ÿßŸÑ ŸÖŸÜ ÿßŸÑŸÖŸÇÿØŸÖ...
            </div>

            <div
                class="choices"
            >
                <div
                    class="choice"
                    data-sticker="ÿßŸÉÿ™ÿ®Ÿàÿß Ÿ°"
                    id="choiceWrapper1"
                >
                    <div
                        id="choice1"
                        class="btn"
                    >
                        ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑÿ£ŸàŸÑ
                    </div>
                </div>

                <div
                    class="choice"
                    data-sticker="ÿßŸÉÿ™ÿ®Ÿàÿß Ÿ¢"
                    id="choiceWrapper2"
                >
                    <div
                        id="choice2"
                        class="btn"
                    >
                        ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑÿ´ÿßŸÜŸä
                    </div>
                </div>

                <div
                    class="choice"
                    data-sticker="ÿßŸÉÿ™ÿ®Ÿàÿß Ÿ£"
                    id="choiceWrapper3"
                >
                    <div
                        id="choice3"
                        class="btn"
                    >
                        ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑÿ´ÿßŸÑÿ´
                    </div>
                </div>

                <div
                    class="choice"
                    data-sticker="ÿßŸÉÿ™ÿ®Ÿàÿß Ÿ§"
                    id="choiceWrapper4"
                >
                    <div
                        id="choice4"
                        class="btn"
                    >
                        ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑÿ±ÿßÿ®ÿπ
                    </div>
                </div>
            </div>

            <div
                id="status"
                class="status connected"
            >
                üü¢ ÿ¨ÿßŸáÿ≤ - ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™
            </div>
        </div>
    </div>

    <!-- =================================================================================
         SCRIPT ‚Äî SAME LOGIC (JSONBin polling, timestamps, updates)
         NO Firebase, NO MyJSON changes, NOTHING else altered.
         ================================================================================= -->
    <script>
        /* -------------------------------------------------------------------------
           State
           ------------------------------------------------------------------------- */
        let lastTimestamp = 0;
        let checkInterval;

        let BIN_ID = localStorage.getItem('q8_bin_id');
        let API_KEY = localStorage.getItem('q8_api_key');

        /* -------------------------------------------------------------------------
           Setup overlay controls (UI ONLY)
           ------------------------------------------------------------------------- */
        const setupOverlay = document.getElementById('setupOverlay');
        const binInput     = document.getElementById('binIdInput');
        const keyInput     = document.getElementById('apiKeyInput');

        if (BIN_ID) {
            binInput.value = BIN_ID;
        }

        if (API_KEY) {
            keyInput.value = API_KEY;
        }

        function hideSetup() {
            setupOverlay.classList.add('hidden');
            document.body.style.overflow = 'hidden';
        }

        function showSetup() {
            setupOverlay.classList.remove('hidden');
            document.body.style.overflow = 'auto';
            setTimeout(function () {
                binInput.focus();
            }, 50);
        }

        if (!BIN_ID || !API_KEY) {
            showSetup();
        } else {
            hideSetup();
        }

        document.getElementById('saveSetupBtn').addEventListener('click', function () {
            const b = binInput.value.trim();
            const k = keyInput.value.trim();

            if (!b || !k) {
                alert('ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ£ÿØÿÆŸÑ Bin ID Ÿà Master Key');
                return;
            }

            localStorage.setItem('q8_bin_id', b);
            localStorage.setItem('q8_api_key', k);

            BIN_ID = b;
            API_KEY = k;

            hideSetup();
            startChecking();
            loadInitialData();
        });

        document.getElementById('resetSetupBtn').addEventListener('click', function () {
            if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ÿü')) {
                return;
            }

            localStorage.removeItem('q8_bin_id');
            localStorage.removeItem('q8_api_key');

            BIN_ID  = null;
            API_KEY = null;

            showSetup();
        });

        /* -------------------------------------------------------------------------
           Animations / Status (unchanged)
           ------------------------------------------------------------------------- */
        function showUpdateAnimation() {
            const statusEl   = document.getElementById('status');
            const questionEl = document.getElementById('question');

            statusEl.textContent = '‚ö° ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑÿ™Ÿà!';
            statusEl.className   = 'status updating';

            questionEl.classList.add('updating');

            document
                .querySelectorAll('.btn')
                .forEach(function (btn) {
                    btn.classList.add('updating');
                });

            setTimeout(function () {
                questionEl.classList.remove('updating');

                document
                    .querySelectorAll('.btn')
                    .forEach(function (btn) {
                        btn.classList.remove('updating');
                    });

                statusEl.textContent = 'üü¢ ŸÖÿ™ÿµŸÑ ŸàŸÖÿ≠ÿØÿ´';
                statusEl.className   = 'status connected';
            }, 2000);
        }

        /* -------------------------------------------------------------------------
           Update UI with data (unchanged)
           ------------------------------------------------------------------------- */
        function updateGameDisplay(data) {
            if (data.title) {
                document.getElementById('title').textContent = data.title;
            }

            if (data.question) {
                document.getElementById('question').textContent = data.question;
            }

            if (data.choices) {
                for (let i = 0; i < 4; i++) {
                    const t    = (data.choices[i] || '').trim();
                    const el   = document.getElementById('choice' + (i + 1));
                    const wrap = document.getElementById('choiceWrapper' + (i + 1));

                    if (t) {
                        el.textContent = t;
                        wrap.classList.remove('hidden');
                    } else {
                        wrap.classList.add('hidden');
                    }
                }
            }
        }

        /* -------------------------------------------------------------------------
           Poll JSONBin latest record (unchanged)
           ------------------------------------------------------------------------- */
        async function checkForUpdates() {
            if (!BIN_ID || !API_KEY) {
                return;
            }

            try {
                const r = await fetch(
                    'https://api.jsonbin.io/v3/b/' + BIN_ID + '/latest',
                    {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': API_KEY
                        }
                    }
                );

                if (r.ok) {
                    const result = await r.json();
                    const data   = result.record;

                    if (data.timestamp && data.timestamp > lastTimestamp) {
                        lastTimestamp = data.timestamp;
                        showUpdateAnimation();
                        updateGameDisplay(data);
                    }
                } else {
                    // Silent: keep viewer up; admin will push next
                }
            } catch (e) {
                // Silent network failure
            }
        }

        /* -------------------------------------------------------------------------
           Load initial data (unchanged)
           ------------------------------------------------------------------------- */
        async function loadInitialData() {
            if (!BIN_ID || !API_KEY) {
                return;
            }

            const statusEl = document.getElementById('status');

            statusEl.textContent = 'üîÑ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...';
            statusEl.className   = 'status';

            try {
                const r = await fetch(
                    'https://api.jsonbin.io/v3/b/' + BIN_ID + '/latest',
                    {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': API_KEY
                        }
                    }
                );

                if (r.ok) {
                    const result = await r.json();
                    const data   = result.record;

                    if (data.timestamp) {
                        lastTimestamp = data.timestamp;
                        updateGameDisplay(data);
                        statusEl.textContent = 'üü¢ ŸÖÿ™ÿµŸÑ ŸàŸÖÿ≠ÿØÿ´';
                        statusEl.className   = 'status connected';
                    }
                } else {
                    statusEl.textContent = '‚ö†Ô∏è ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ© Bin ID Ÿà API Key';
                    statusEl.className   = 'status error';
                }
            } catch (e) {
                statusEl.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ';
                statusEl.className   = 'status error';
            }
        }

        /* -------------------------------------------------------------------------
           Start polling (unchanged)
           ------------------------------------------------------------------------- */
        function startChecking() {
            if (checkInterval) {
                clearInterval(checkInterval);
            }
            checkInterval = setInterval(checkForUpdates, 1000);
        }

        if (BIN_ID && API_KEY) {
            loadInitialData();
            startChecking();
        }

        window.addEventListener('beforeunload', function () {
            if (checkInterval) {
                clearInterval(checkInterval);
            }
        });
    </script>
</body>
</html>
