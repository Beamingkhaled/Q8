<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avenues & Dragons â€” Neon + Tap (Repo Site)</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{font-family:'Tajawal',sans-serif;background:#000;color:#fff;overflow:hidden;user-select:none}
    .bg{position:fixed;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat;filter:blur(6px);transform:scale(1.1);z-index:1}
    .overlay{position:fixed;inset:0;z-index:2;background:rgba(0,0,0,.15)}
    .game-container{position:relative;z-index:3;width:92%;max-width:560px;margin:12vh auto 0;padding:20px;text-align:center;backdrop-filter:blur(6px);background:rgba(10,10,30,.25);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 0 28px rgba(0,0,0,.25)}
    h1{font-size:34px;font-weight:800;margin-bottom:10px;text-shadow:0 0 8px rgba(255,255,255,.4)}
    #question{font-size:22px;margin-bottom:18px;color:#eee;text-shadow:0 0 6px rgba(0,0,0,.4);line-height:1.5}
    .choice{position:relative;background:rgba(20,20,35,.75);border:2px solid #7a5cff;padding:18px;font-size:22px;color:#fff;border-radius:16px;box-shadow:0 0 18px #7a5cff66,inset 0 0 12px #7a5cff22;margin-bottom:18px;transition:.15s ease}
    .choice:active{transform:scale(.97);box-shadow:0 0 26px #a889ffcc,inset 0 0 18px #7a5cff55}
    .sticker{position:absolute;top:-12px;left:-12px;background:rgba(255,255,255,.25);backdrop-filter:blur(6px);padding:6px 12px;border-radius:12px;font-size:16px;font-weight:700;color:#fff;border:1px solid rgba(255,255,255,.45);box-shadow:0 0 12px rgba(255,255,255,.2);pointer-events:none}
    #status{margin-top:10px;font-size:14px;color:#ddd;opacity:.85}
    #tapChallenge{display:none}
    .tap-wrap{display:flex;flex-direction:column;gap:14px;align-items:center}
    .tap-title{font-size:24px;font-weight:800}
    .tap-sub{font-size:16px;opacity:.9}
    .tap-hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;font-size:16px}
    .hud-pill{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:6px 12px;backdrop-filter:blur(6px)}
    .tap-progress{width:100%;height:16px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);border-radius:999px;overflow:hidden}
    .tap-bar{height:100%;width:0%;background:radial-gradient(120% 120% at 0% 50%,#7a5cff,#a46bff);transition:width .08s linear}
    .tap-button{font-size:26px;font-weight:800;padding:14px 28px;border:2px solid #7a5cff;border-radius:16px;color:#fff;background:rgba(20,20,35,.9);box-shadow:0 0 18px #7a5cff66}
    .tap-button:active{transform:scale(.98)}
    .tap-result{font-size:20px;font-weight:800;margin-top:6px}
    .win{color:#7dffae}.lose{color:#ff7d7d}
  </style>
</head>
<body>
  <div class="bg" id="bg" style="background-image:url('bg.jpg')"></div>
  <div class="overlay"></div>

  <div class="game-container" id="card">
    <div id="voteMode">
      <h1 id="title">Avenues & Dragons</h1>
      <div id="question">...</div>
      <div id="choice1" class="choice"><div class="sticker">Ø§ÙƒØªØ¨ÙˆØ§ Ù¡</div><span id="choice1Text">...</span></div>
      <div id="choice2" class="choice"><div class="sticker">Ø§ÙƒØªØ¨ÙˆØ§ Ù¢</div><span id="choice2Text">...</span></div>
      <div id="status">Ù…ØªØµÙ„ Â· ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
    </div>

    <div id="tapChallenge">
      <div class="tap-wrap">
        <div class="tap-title" id="tapTitle">ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„Ø·Ù‚ ğŸ”¥</div>
        <div class="tap-sub" id="tapDesc">Ø§Ø¶ØºØ·ÙˆØ§ Ø¨Ø£Ø³Ø±Ø¹ Ù…Ø§ ÙŠÙ…ÙƒÙ†!</div>
        <div class="tap-hud">
          <div class="hud-pill">Ø§Ù„Ù‡Ø¯Ù: <span id="tapGoal">1000</span></div>
          <div class="hud-pill">Ø§Ù„ÙˆÙ‚Øª: <span id="tapTimer">60</span></div>
          <div class="hud-pill">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="tapCount">0</span></div>
        </div>
        <div class="tap-progress"><div class="tap-bar" id="tapBar"></div></div>
        <button class="tap-button" id="tapButton">Ø·ÙÙ‚!</button>
        <div class="tap-result" id="tapResult"></div>
      </div>
      <div id="statusTap" style="margin-top:10px;font-size:14px">Ù…ØªØµÙ„ Â· ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
    </div>
  </div>

  <script>
    // Resolve /Q8/backend.json correctly on a repo site
    const BASE_URL = new URL('backend.json', location.href).toString();

    // Optional choices override (MyJSON)
    const qs = new URLSearchParams(location.search);
    const CHOICES_URL_PARAM = qs.get('choices_url');

    const POLL_MS = 1000;

    let mode = null, tapTimer = null, tapGoal = 0, tapCount = 0, tapEnd = 0;

    const el = {
      bg: document.getElementById('bg'),
      title: document.getElementById('title'),
      vote: document.getElementById('voteMode'),
      tap: document.getElementById('tapChallenge'),
      q: document.getElementById('question'),
      c1: document.getElementById('choice1Text'),
      c2: document.getElementById('choice2Text'),
      st: document.getElementById('status'),
      stt: document.getElementById('statusTap'),
      tapTitle: document.getElementById('tapTitle'),
      tapDesc: document.getElementById('tapDesc'),
      tapGoal: document.getElementById('tapGoal'),
      tapTimer: document.getElementById('tapTimer'),
      tapCount: document.getElementById('tapCount'),
      tapBar: document.getElementById('tapBar'),
      tapBtn: document.getElementById('tapButton'),
      tapResult: document.getElementById('tapResult')
    };

    function showVote(){ el.tap.style.display='none'; el.vote.style.display='block'; mode='vote'; }
    function showTap(){ el.vote.style.display='none'; el.tap.style.display='block'; mode='tap'; }
    function stopTap(){ clearInterval(tapTimer); tapTimer=null; }

    function startTap(cfg){
      stopTap();
      tapGoal = Number(cfg.goal || 1000);
      tapCount = 0;
      const duration = Number(cfg.duration || 60);
      tapEnd = Date.now() + duration*1000;

      el.tapTitle.textContent = cfg.title || 'ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„Ø·Ù‚ ğŸ”¥';
      el.tapDesc.textContent  = cfg.description || 'Ø§Ø¶ØºØ·ÙˆØ§ Ø¨Ø£Ø³Ø±Ø¹ Ù…Ø§ ÙŠÙ…ÙƒÙ†!';
      el.tapGoal.textContent  = tapGoal;
      el.tapCount.textContent = tapCount;
      el.tapTimer.textContent = duration;
      el.tapBar.style.width   = '0%';
      el.tapResult.textContent = '';

      el.tapBtn.onclick = () => {
        if (Date.now() < tapEnd) {
          tapCount++; el.tapCount.textContent=tapCount;
          el.tapBar.style.width = Math.min(100, tapCount/tapGoal*100) + '%';
        }
      };
      document.getElementById('card').onclick = (e)=>{
        if(e.target===el.tapBtn) return;
        if(Date.now()<tapEnd && mode==='tap'){
          tapCount++; el.tapCount.textContent=tapCount;
          el.tapBar.style.width = Math.min(100, tapCount/tapGoal*100) + '%';
        }
      };

      tapTimer = setInterval(()=>{
        let left = Math.ceil((tapEnd - Date.now())/1000); if(left<0) left=0;
        el.tapTimer.textContent = left;
        if(left===0){
          stopTap();
          if(tapCount>=tapGoal){ el.tapResult.textContent='ğŸ”¥ Ù…Ø¨Ø±ÙˆÙƒ! Ù†Ø¬Ø­ØªÙˆØ§!'; el.tapResult.className='tap-result win'; }
          else { el.tapResult.textContent='ğŸ˜®â€ğŸ’¨ Ù…Ø§ Ù„Ø­Ù‘Ù‚Ù†Ø§!'; el.tapResult.className='tap-result lose'; }
        }
      },200);
    }

    async function fetchJSON(url){
      const sep = url.includes('?') ? '&' : '?';
      const res = await fetch(url + sep + 'nocache=' + Date.now());
      return res.json();
    }

    async function loop(){
      try{
        // 1) Load backend.json (title/question/mode/bg/tap)
        const base = await fetchJSON(BASE_URL);
        const data = base && base.record ? base.record : base;

        // Title & Question from backend.json
        el.title.textContent   = data.title    || 'Avenues & Dragons';
        el.q.textContent       = data.question || '...';

        // Background
        if (data.bg) el.bg.style.backgroundImage = `url('${data.bg}')`;

        // Mode switch
        const newMode = (data.mode || 'vote').toLowerCase();
        if(newMode==='tap'){ if(mode!=='tap'){ showTap(); startTap(data.tap||{});} el.stt.textContent='Ù…ØªØµÙ„ Â· ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§'; }
        else { if(mode!=='vote'){ showVote(); stopTap(); } el.st.textContent='Ù…ØªØµÙ„ Â· ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§'; }

        // 2) Choices: default from backend, override via ?choices_url (MyJSON)
        let c1 = data.choice1 || '...';
        let c2 = data.choice2 || '...';

        if (CHOICES_URL_PARAM) {
          try {
            const choicesURL = decodeURIComponent(CHOICES_URL_PARAM);
            const c = await fetchJSON(choicesURL);
            const obj = c && c.data ? c.data : c; // MyJSON returns {data:{...}}
            if (obj) {
              if (Array.isArray(obj.choices) && obj.choices.length>=2){ c1=String(obj.choices[0]); c2=String(obj.choices[1]); }
              else if (obj.choice1 && obj.choice2){ c1=String(obj.choice1); c2=String(obj.choice2); }
              else if (obj.one && obj.two){ c1=String(obj.one); c2=String(obj.two); }
            }
          } catch { /* keep fallback */ }
        }

        if(mode!=='tap'){ el.c1.textContent=c1; el.c2.textContent=c2; }

      }catch(e){
        if(mode==='tap') el.stt.textContent='ØºÙŠØ± Ù…ØªØµÙ„';
        else el.st.textContent='ØºÙŠØ± Ù…ØªØµÙ„';
      }
    }

    setInterval(loop, 1000);
    loop();
  </script>
</body>
</html>
