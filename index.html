<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avenues & Dragons â€” Neon + Tap Challenge</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      user-select: none;
    }

    /* Background */
    .bg {
      position: fixed; inset: 0;
      background-size: cover; background-position: center; background-repeat: no-repeat;
      filter: blur(6px); transform: scale(1.1);
      z-index: 1;
    }

    /* Light overlay (0.15) */
    .overlay {
      position: fixed; inset: 0; z-index: 2;
      background: rgba(0,0,0,0.15);
    }

    /* Main card */
    .game-container {
      position: relative; z-index: 3;
      width: 92%; max-width: 560px; margin: 12vh auto 0; padding: 20px;
      text-align: center;
      backdrop-filter: blur(6px);
      background: rgba(10,10,30,0.25);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      box-shadow: 0 0 28px rgba(0,0,0,0.25);
    }

    h1 {
      font-size: 34px; font-weight: 800; margin-bottom: 10px;
      text-shadow: 0 0 8px rgba(255,255,255,0.4);
    }

    #question {
      font-size: 22px; margin-bottom: 18px; color: #eee;
      text-shadow: 0 0 6px rgba(0,0,0,0.4);
      line-height: 1.5;
    }

    /* Neon boxes (Option 5) */
    .choice {
      position: relative; /* needed for sticker */
      background: rgba(20,20,35,0.75);
      border: 2px solid #7a5cff;
      padding: 18px;
      font-size: 22px;
      color: #fff;
      border-radius: 16px;
      box-shadow: 0 0 18px #7a5cff66, inset 0 0 12px #7a5cff22;
      margin-bottom: 18px;
      transition: 0.15s ease;
    }
    .choice:active { transform: scale(0.97); box-shadow: 0 0 26px #a889ffcc, inset 0 0 18px #7a5cff55; }

    /* CTA sticker */
    .sticker {
      position: absolute; top: -12px; left: -12px;
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(6px);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 16px; font-weight: 700; color: #fff;
      border: 1px solid rgba(255,255,255,0.45);
      box-shadow: 0 0 12px rgba(255,255,255,0.2);
      pointer-events: none;
    }

    /* Status line */
    #status { margin-top: 10px; font-size: 14px; color: #ddd; opacity: 0.85; }

    /* Tap Challenge UI */
    #tapChallenge { display: none; }
    .tap-wrap {
      display: flex; flex-direction: column; gap: 14px; align-items: center;
    }
    .tap-title {
      font-size: 24px; font-weight: 800; text-shadow: 0 0 8px rgba(255,255,255,0.35);
    }
    .tap-sub { font-size: 16px; opacity: 0.9; }

    .tap-hud {
      display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap;
      font-size: 16px;
    }
    .hud-pill {
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.35);
      border-radius: 999px;
      padding: 6px 12px;
      backdrop-filter: blur(6px);
    }

    .tap-progress {
      width: 100%;
      height: 16px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 999px;
      overflow: hidden;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
    }
    .tap-bar {
      height: 100%; width: 0%;
      background: radial-gradient(120% 120% at 0% 50%, #7a5cff, #a46bff);
      box-shadow: 0 0 18px #7a5cff88;
      transition: width 0.08s linear;
    }

    .tap-button {
      font-family: inherit;
      font-size: 26px; font-weight: 800;
      padding: 14px 28px;
      border: 2px solid #7a5cff;
      border-radius: 16px;
      color: #fff;
      background: rgba(20,20,35,0.9);
      box-shadow: 0 0 18px #7a5cff66, inset 0 0 12px #7a5cff22;
      cursor: pointer;
      touch-action: manipulation;
    }
    .tap-button:active { transform: scale(0.98); box-shadow: 0 0 26px #a889ffcc, inset 0 0 18px #7a5cff55; }

    .tap-result {
      font-size: 20px; font-weight: 800; margin-top: 6px;
      text-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    .win { color: #7dffae; }
    .lose { color: #ff7d7d; }
    @media (max-height: 680px) {
      .game-container { margin-top: 8vh; }
    }
  </style>
</head>
<body>

  <!-- Background -->
  <div class="bg" id="bg" style="background-image: url('bg.jpg');"></div>
  <div class="overlay"></div>

  <!-- Card -->
  <div class="game-container" id="card">

    <!-- VOTE MODE -->
    <div id="voteMode">
      <h1>Avenues & Dragons</h1>
      <div id="question">...</div>

      <div id="choice1" class="choice">
        <div class="sticker">Ø§ÙƒØªØ¨ÙˆØ§ Ù¡</div>
        <span id="choice1Text">...</span>
      </div>

      <div id="choice2" class="choice">
        <div class="sticker">Ø§ÙƒØªØ¨ÙˆØ§ Ù¢</div>
        <span id="choice2Text">...</span>
      </div>

      <div id="status">Ù…ØªØµÙ„ Â· ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
    </div>

    <!-- TAP CHALLENGE MODE -->
    <div id="tapChallenge">
      <div class="tap-wrap">
        <div class="tap-title" id="tapTitle">ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„Ø·Ù‚ ğŸ”¥</div>
        <div class="tap-sub" id="tapDesc">Ø§Ø¶ØºØ·ÙˆØ§ Ø¨Ø£Ø³Ø±Ø¹ Ù…Ø§ ÙŠÙ…ÙƒÙ† Ø®Ù„Ø§Ù„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯!</div>

        <div class="tap-hud">
          <div class="hud-pill">Ø§Ù„Ù‡Ø¯Ù: <span id="tapGoal">1000</span> Ø·Ù‚Ø©</div>
          <div class="hud-pill">Ø§Ù„ÙˆÙ‚Øª: <span id="tapTimer">60</span> Ø«Ø§Ù†ÙŠØ©</div>
          <div class="hud-pill">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="tapCount">0</span></div>
        </div>

        <div class="tap-progress"><div class="tap-bar" id="tapBar"></div></div>

        <button class="tap-button" id="tapButton">Ø·ÙÙ‚!</button>
        <div class="tap-result" id="tapResult"></div>
      </div>

      <div id="statusTap" style="margin-top:10px; font-size:14px; opacity:0.85;">Ù…ØªØµÙ„ Â· ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
    </div>

  </div>

  <script>
    // ====== CONFIG ======
    const BACKEND_URL = "https://beamingkhaled.github.io/backend.json";
    const POLL_MS = 1000; // keep it snappy
    // ====================

    let currentMode = null; // 'vote' or 'tap'
    let tapTimerId = null;
    let tapRemaining = 0;
    let tapGoal = 1000;
    let tapCount = 0;
    let tapEndTime = 0;

    const el = {
      bg: document.getElementById('bg'),
      voteMode: document.getElementById('voteMode'),
      tapMode: document.getElementById('tapChallenge'),
      question: document.getElementById('question'),
      choice1Text: document.getElementById('choice1Text'),
      choice2Text: document.getElementById('choice2Text'),
      status: document.getElementById('status'),
      statusTap: document.getElementById('statusTap'),
      // tap elements
      tapTitle: document.getElementById('tapTitle'),
      tapDesc: document.getElementById('tapDesc'),
      tapGoal: document.getElementById('tapGoal'),
      tapTimer: document.getElementById('tapTimer'),
      tapCount: document.getElementById('tapCount'),
      tapBar: document.getElementById('tapBar'),
      tapBtn: document.getElementById('tapButton'),
      tapResult: document.getElementById('tapResult'),
    };

    function showMode(mode) {
      if (mode === 'tap') {
        el.voteMode.style.display = 'none';
        el.tapMode.style.display = 'block';
      } else {
        el.tapMode.style.display = 'none';
        el.voteMode.style.display = 'block';
      }
      currentMode = mode;
    }

    function startTapChallenge(cfg) {
      // cfg: { title, description, goal, duration }
      stopTapChallenge();
      tapGoal = Math.max(1, Number(cfg.goal || 1000));
      tapCount = 0;
      const duration = Math.max(1, Number(cfg.duration || 60));
      tapRemaining = duration;
      tapEndTime = Date.now() + duration * 1000;
      el.tapTitle.textContent = cfg.title || 'ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„Ø·Ù‚ ğŸ”¥';
      el.tapDesc.textContent = cfg.description || 'Ø§Ø¶ØºØ·ÙˆØ§ Ø¨Ø£Ø³Ø±Ø¹ Ù…Ø§ ÙŠÙ…ÙƒÙ† Ø®Ù„Ø§Ù„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯!';
      el.tapGoal.textContent = tapGoal;
      el.tapCount.textContent = tapCount;
      el.tapTimer.textContent = tapRemaining;
      el.tapBar.style.width = '0%';
      el.tapResult.textContent = '';

      tapTimerId = setInterval(() => {
        const now = Date.now();
        tapRemaining = Math.max(0, Math.ceil((tapEndTime - now) / 1000));
        el.tapTimer.textContent = tapRemaining;
        const pct = Math.min(100, (tapCount / tapGoal) * 100);
        el.tapBar.style.width = pct + '%';

        if (tapRemaining <= 0) {
          stopTapChallenge();
          // show result
          if (tapCount >= tapGoal) {
            el.tapResult.textContent = 'ğŸ”¥ Ù…Ø¨Ø±ÙˆÙƒ! Ø£Ù†Ø¬Ø²ØªÙˆØ§ Ø§Ù„ØªØ­Ø¯Ù‘ÙŠ!';
            el.tapResult.className = 'tap-result win';
          } else {
            el.tapResult.textContent = 'ğŸ˜®â€ğŸ’¨ Ù…Ø§ Ù„Ø­Ù‘Ù‚Ù†Ø§â€¦ Ù…Ø±Ù‘Ø© Ø«Ø§Ù†ÙŠØ©!';
            el.tapResult.className = 'tap-result lose';
          }
        }
      }, 200);

      // tapping anywhere on the button (and screen on mobile if needed)
      el.tapBtn.onclick = () => {
        if (Date.now() <= tapEndTime) {
          tapCount++;
          el.tapCount.textContent = tapCount;
          const pct = Math.min(100, (tapCount / tapGoal) * 100);
          el.tapBar.style.width = pct + '%';
        }
      };
      // Optional: also allow whole card taps to count during challenge
      document.getElementById('card').onclick = (e) => {
        // prevent double counting when clicking the button
        if (e.target === el.tapBtn) return;
        if (currentMode === 'tap' && Date.now() <= tapEndTime) {
          tapCount++;
          el.tapCount.textContent = tapCount;
          const pct = Math.min(100, (tapCount / tapGoal) * 100);
          el.tapBar.style.width = pct + '%';
        }
      };
    }

    function stopTapChallenge() {
      if (tapTimerId) {
        clearInterval(tapTimerId);
        tapTimerId = null;
      }
      // remove the global click if any
      document.getElementById('card').onclick = null;
    }

    async function fetchData() {
      try {
        const res = await fetch(BACKEND_URL + '?nocache=' + Date.now());
        const data = await res.json();

        // Background override if provided
        if (data.bg && typeof data.bg === 'string') {
          el.bg.style.backgroundImage = `url('${data.bg}')`;
        } else {
          el.bg.style.backgroundImage = `url('bg.jpg')`;
        }

        const mode = (data.mode || 'vote').toLowerCase();

        if (mode === 'tap') {
          // prepare tap screen
          if (currentMode !== 'tap') {
            showMode('tap');
            startTapChallenge({
              title: data?.tap?.title,
              description: data?.tap?.description,
              goal: data?.tap?.goal,
              duration: data?.tap?.duration
            });
          }
          el.statusTap.textContent = 'Ù…ØªØµÙ„ Â· ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§';
        } else {
          // vote mode
          if (currentMode !== 'vote') {
            showMode('vote');
            stopTapChallenge();
          }
          el.question.textContent = data.question || '...';
          el.choice1Text.textContent = data.choice1 || '...';
          el.choice2Text.textContent = data.choice2 || '...';
          el.status.textContent = 'Ù…ØªØµÙ„ Â· ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§';
        }

      } catch (e) {
        if (currentMode === 'tap') {
          el.statusTap.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„ Â· Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
        } else {
          el.status.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„ Â· Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
        }
      }
    }

    // Polling
    setInterval(fetchData, POLL_MS);
    fetchData();

    // Prevent space/enter from scrolling while tapping on desktop
    window.addEventListener('keydown', (e) => {
      if (currentMode === 'tap' && (e.code === 'Space' || e.code === 'Enter')) {
        e.preventDefault();
        // bonus: use keyboard to tap
        if (Date.now() <= tapEndTime) {
          tapCount++;
          el.tapCount.textContent = tapCount;
          const pct = Math.min(100, (tapCount / tapGoal) * 100);
          el.tapBar.style.width = pct + '%';
        }
      }
    }, { passive: false });
  </script>
</body>
</html>
