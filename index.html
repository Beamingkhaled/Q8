<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Live Choices Front-End</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body{font-family:Tajawal,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#000;color:#fff;margin:0}
    .wrap{max-width:900px;margin:40px auto;padding:20px}
    h1{font-size:24px;margin:0 0 12px}
    .scene{border:1px solid #222;border-radius:14px;padding:18px;background:#0e0e0e}
    .title{font-size:22px;margin-bottom:12px;opacity:.95}
    .choices{display:grid;gap:12px}
    .btn{padding:16px;border-radius:12px;border:1px solid #333;background:#141414;font-size:20px}
    /* Debug panel */
    .debug{position:fixed;left:10px;bottom:10px;background:#131313;border:1px solid #333;border-radius:10px;padding:12px;max-width:90vw}
    .debug code{white-space:pre-wrap;word-break:break-word;font-size:12px}
    .bad{color:#ff7676}
    .ok{color:#7dffa3}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©</h1>
    <div class="scene">
      <div id="sceneTitle" class="title">‚Ä¶</div>
      <div class="choices">
        <button id="choiceLeft"  class="btn">‚Ä¶</button>
        <button id="choiceRight" class="btn">‚Ä¶</button>
      </div>
    </div>
  </div>

  <div class="debug">
    <div><b>Backend status:</b> <span id="dbgStatus">‚Äì</span></div>
    <div><b>Last fetch:</b> <span id="dbgTime">‚Äì</span></div>
    <div><b>URL:</b> <code id="dbgUrl"></code></div>
    <details style="margin-top:6px">
      <summary>Payload</summary>
      <code id="dbgPayload">{}</code>
    </details>
    <details>
      <summary>Errors</summary>
      <code id="dbgErrors">None</code>
    </details>
  </div>

  <script>
    // üîÅ CHANGE THIS to your backend site (must be HTTPS and include trailing slash if it's a project page):
    // Examples:
    //  - User site:   https://yourname.github.io/
    //  - Project site: https://yourname.github.io/your-backend-repo/
    const BACKEND_URL = 'https://YOUR-BACKEND-SITE.github.io/'; // <-- EDIT ME

    // Debug helpers
    const dbg = {
      url: document.getElementById('dbgUrl'),
      status: document.getElementById('dbgStatus'),
      time: document.getElementById('dbgTime'),
      payload: document.getElementById('dbgPayload'),
      errors: document.getElementById('dbgErrors'),
      logError(msg){ this.errors.textContent = msg; this.status.className='bad'; },
      ok(msg){ this.status.textContent = msg; this.status.className='ok'; }
    };
    dbg.url.textContent = BACKEND_URL;

    let lastHash = '';

    async function fetchLiveChoices(){
      try{
        const url = BACKEND_URL.endsWith('/') ? BACKEND_URL : BACKEND_URL + '/';
        const res = await fetch(url, {
          cache: 'no-store',
          headers: {'Pragma':'no-cache','Cache-Control':'no-cache'}
        });

        const html = await res.text();
        // Robust parse: use DOMParser and grab <pre id="LIVE_CHOICES_JSON">
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const pre = doc.querySelector('#LIVE_CHOICES_JSON');
        if(!pre){
          dbg.logError('Could not find <pre id="LIVE_CHOICES_JSON"> in backend HTML. Check markers.');
          return;
        }

        const jsonText = pre.textContent.trim();
        let data;
        try { data = JSON.parse(jsonText); }
        catch(e){ dbg.logError('JSON parse error. Did the JSON block get corrupted?'); return; }

        // Hash compare
        const h = JSON.stringify(data);
        if(h !== lastHash){
          applyChoices(data);
          lastHash = h;
          dbg.payload.textContent = JSON.stringify(data, null, 2);
        }

        dbg.ok('OK (' + res.status + ')');
        dbg.time.textContent = new Date().toLocaleTimeString();
      } catch(err){
        dbg.logError((err && err.message) ? err.message : String(err));
      }
    }

    function applyChoices(data){
      const titleEl = document.getElementById('sceneTitle');
      const leftEl  = document.getElementById('choiceLeft');
      const rightEl = document.getElementById('choiceRight');

      titleEl.textContent = data.title || '';
      leftEl.textContent  = data.left  || '';
      rightEl.textContent = data.right || '';
    }

    // First run + polling
    fetchLiveChoices();
    setInterval(fetchLiveChoices, 2000);
  </script>
</body>
</html>
