<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>لوحة التحكم — MyJSON (PUT بدون استهلاك رصيد)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<style>
:root{--accent:#7a5cff}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:"Tajawal",sans-serif;background:#0b0b12;color:#fff}
.wrap{max-width:760px;margin:24px auto;padding:16px}
h1{margin:0 0 12px;font-weight:800}
.card{background:rgba(18,18,40,.9);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px;margin-bottom:16px}
.row{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:center;margin:10px 0}
input,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;font-size:16px}
textarea{min-height:64px}
button{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:800;font-size:16px;cursor:pointer;background:var(--accent);color:#fff}
.btn-row{display:flex;gap:10px;flex-wrap:wrap}
.small{font-size:12px;opacity:.8;margin-top:8px}
.ok{color:#7dff96}.err{color:#ff7d8f}
.link{word-break:break-all}
</style>
</head>
<body>
<div class="wrap">
  <h1>لوحة التحكّم (تعديل مباشر على نفس السجل — بدون استهلاك رصيد)</h1>

  <div class="card">
    <div class="row"><label>رابط MyJSON</label><input id="url" placeholder="https://api.myjson.online/v1/records/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"></div>
    <div class="row"><label>API Key (اختياري)</label><input id="key" placeholder="إن كان حسابك يطلبه"></div>
    <div class="btn-row">
      <button id="saveUrl" style="background:#444">حفظ الرابط/المفتاح</button>
      <button id="load">تحميل المحتوى الحالي</button>
      <button id="openView" style="background:#2c2c3f">فتح صفحة العرض</button>
      <button id="openEdit" style="background:#2c2c3f">فتح سجل MyJSON</button>
    </div>
    <div id="status" class="small"></div>
  </div>

  <div class="card">
    <div class="row"><label>العنوان</label><input id="title" placeholder="Avenues & Dragons"></div>
    <div class="row"><label>السؤال</label><textarea id="question" placeholder="…"></textarea></div>
    <div class="row"><label>الخيار ١</label><input id="choice1" placeholder="…"></div>
    <div class="row"><label>الخيار ٢</label><input id="choice2" placeholder="…"></div>
    <div class="row"><label>الخلفية</label><input id="bg" placeholder="bg.jpg أو رابط صورة"></div>
    <div class="btn-row">
      <button id="save">حفظ الآن (PUT)</button>
    </div>
    <div class="small">يحفظ على نفس السجل في MyJSON باستخدام <b>PUT</b> — صفحة العرض تتحدث تلقائيًا.</div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const viewerLink = u => location.origin + "/Q8/?data_url=" + encodeURIComponent(u);

function setStatus(msg, ok){ $('status').innerHTML = ok ? `<span class="ok">${msg}</span>` : `<span class="err">${msg}</span>`; }

// Restore saved URL/key
$('url').value = localStorage.getItem('myjson_data_url') || "";
$('key').value = localStorage.getItem('myjson_api_key') || "";

// Buttons
$('saveUrl').onclick = ()=>{
  localStorage.setItem('myjson_data_url', $('url').value.trim());
  localStorage.setItem('myjson_api_key', $('key').value.trim());
  setStatus('تم حفظ الرابط والمفتاح (إن وجد) ✅', true);
};
$('openView').onclick = ()=>{
  const u=$('url').value.trim(); if(!u) return setStatus('أدخل رابطًا صحيحًا أولًا', false);
  window.open(viewerLink(u),'_blank');
};
$('openEdit').onclick = ()=>{
  const u=$('url').value.trim(); if(!u) return setStatus('أدخل رابطًا صحيحًا أولًا', false);
  window.open(u,'_blank');
};

// Load current content (GET)
$('load').onclick = async ()=>{
  const u=$('url').value.trim(); if(!u) return setStatus('أدخل رابط MyJSON', false);
  try{
    const r = await fetch(u + (u.includes('?')?'&':'?') + '_ts=' + Date.now());
    const j = await r.json();
    const d = j && j.data ? j.data : j;
    $('title').value   = d.title || '';
    $('question').value= d.question || '';
    $('choice1').value = d.choice1 || '';
    $('choice2').value = d.choice2 || '';
    $('bg').value      = d.bg || '';
    setStatus('تم التحميل ✅', true);
  }catch(e){
    setStatus('فشل التحميل ❌ — تحقق من الرابط', false);
  }
};

// Save using PUT (no credits)
$('save').onclick = async ()=>{
  const u=$('url').value.trim(); if(!u) return setStatus('أدخل رابط MyJSON', false);
  const key=$('key').value.trim();
  const headers={'Content-Type':'application/json'};
  if(key) headers['X-API-KEY']=key;

  const payload = { data:{
    title: $('title').value.trim() || 'Avenues & Dragons',
    question: $('question').value.trim() || '…',
    choice1: $('choice1').value.trim() || '…',
    choice2: $('choice2').value.trim() || '…',
    bg: $('bg').value.trim() || ''
  }};
  try{
    const r = await fetch(u, { method:'PUT', headers, body: JSON.stringify(payload) });
    if(!r.ok){
      const txt = await r.text();
      // Helpful errors
      if(r.status===401 || r.status===403){
        throw new Error('السجل يتطلب API Key — الصق المفتاح ثم جرّب الحفظ مجددًا.');
      }
      if(r.status===404){
        throw new Error('الرابط غير صحيح أو محذوف — افتح السجل من زر "فتح سجل MyJSON".');
      }
      throw new Error(txt || ('HTTP '+r.status));
    }
    setStatus('تم الحفظ ✅ — نفس الرابط، بدون استهلاك رصيد.', true);
  }catch(e){
    setStatus('فشل الحفظ ❌ — ' + (e.message || e), false);
  }
};
</script>
</body>
</html>
