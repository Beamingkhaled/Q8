<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#000;--card:#111;--border:#222;--text:#fff;--ok:#28c76f;--muted:#9aa0a6;--radius:16px}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Tajawal',system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{width:min(900px,94vw);margin:24px auto;padding:8px 10px 40px}
    h1{font-size:26px;margin:10px 0 18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 14px;margin:14px 0;box-shadow:0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04)}
    label{display:block;font-weight:800;margin:6px 2px 8px}
    input,textarea,select{
      width:100%;background:#0b0b0b;border:1px solid #1f1f1f;border-radius:12px;color:#fff;
      padding:14px 12px;font-size:16px;outline:none
    }
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
    button{
      background:#191919;border:1px solid #2b2b2b;border-radius:14px;color:#fff;
      padding:14px 16px;font-size:16px;font-weight:800;cursor:pointer; width:100%;
    }
    button.primary{background:#1a3a22;border-color:#285d3a}
    .ok{color:var(--ok);font-weight:800}
    pre{white-space:pre-wrap;word-break:break-word;max-height:50vh;overflow:auto;background:#0b0b0b;border:1px solid #1f1f1f;border-radius:12px;padding:12px}
    .muted{color:var(--muted);font-size:13px}
    a{color:#9ad3ff;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” ØªØ­Ø¯ÙŠØ« <code>choices.json</code></h1>

    <div class="card">
      <label>ğŸ”‘ GitHub Token (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</label>
      <input id="token" type="password" placeholder="ghp_xxx Ø£Ùˆ github_pat_xxx" />
      <div class="muted">ÙŠÙØ®Ø²Ù† Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…ØªØµÙØ­Ùƒ ÙÙ‚Ø·. Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <b>contents:write</b>.</div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="owner" value="beamingkhaled" />
        </div>
        <div>
          <label>ğŸ“¦ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</label>
          <input id="repo" value="Q8" />
        </div>
        <div>
          <label>ğŸŒ¿ Ø§Ù„ÙØ±Ø¹</label>
          <input id="branch" value="main" />
        </div>
        <div>
          <label>ğŸ“„ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù</label>
          <input id="path" value="choices.json" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´Ù‡Ø¯</label>
          <input id="title" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…ÙˆÙ„ â€” Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø£ÙˆÙ„" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Ø§Ù„Ø®ÙŠÙ€Ø§Ø± Ø§Ù„Ø£ÙŠØ³Ø±</label>
          <input id="left" placeholder="Ù†Ø¯Ø®Ù„ Ø§Ù„Ù‚Ù‡ÙˆØ©ØŸ" />
        </div>
        <div>
          <label>Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙŠÙ…Ù†</label>
          <input id="right" placeholder="Ù†ØªÙ…Ø´Ù‰ Ø£ÙˆÙ„ØŸ" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="primary" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø¥Ù„Ù‰ <code>choices.json</code></button>
        <button id="loadBtn">âŸ³ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
      </div>

      <div id="status" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„ØªØ£ÙƒÙŠØ¯)</label>
      <pre id="preview">â€”</pre>
      <div class="muted">Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªØ¸Ù‡Ø± ÙÙˆØ±Ù‹Ø§ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ØªÙ‚Ø±Ø£ Ø§Ù„Ù…Ù„Ù ÙƒÙ„ 4 Ø«ÙˆØ§Ù†Ù Ù…Ø¹ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´).</div>
    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);
  const tokenInput  = $('token');
  const ownerInput  = $('owner');
  const repoInput   = $('repo');
  const branchInput = $('branch');
  const pathInput   = $('path');
  const titleInput  = $('title');
  const leftInput   = $('left');
  const rightInput  = $('right');
  const statusEl    = $('status');
  const previewEl   = $('preview');

  // restore saved settings
  tokenInput.value  = localStorage.getItem('gh_token')  || '';
  ownerInput.value  = localStorage.getItem('gh_owner')  || ownerInput.value;
  repoInput.value   = localStorage.getItem('gh_repo')   || repoInput.value;
  branchInput.value = localStorage.getItem('gh_branch') || branchInput.value;
  pathInput.value   = localStorage.getItem('gh_path')   || pathInput.value;

  function saveLocals(){
    localStorage.setItem('gh_token',  tokenInput.value.trim());
    localStorage.setItem('gh_owner',  ownerInput.value.trim());
    localStorage.setItem('gh_repo',   repoInput.value.trim());
    localStorage.setItem('gh_branch', branchInput.value.trim());
    localStorage.setItem('gh_path',   pathInput.value.trim());
  }

  // --- GitHub API helpers ---
  const GH_HEADERS = () => ({
    Authorization:`Bearer ${tokenInput.value.trim()}`,
    Accept:'application/vnd.github+json',
    'X-GitHub-Api-Version':'2022-11-28'
  });

  async function githubGetContents(owner, repo, path, ref){
    const res = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(ref)}&_=${Date.now()}`,
      { headers: GH_HEADERS() }
    );
    if(res.status === 404) return null;
    if(!res.ok) throw new Error('GET '+res.status+' '+(await res.text()));
    return res.json();
  }

  async function githubPutContents(owner, repo, path, message, contentB64, sha, branch){
    const body = { message, content: contentB64, branch };
    if(sha) body.sha = sha;               // always send sha if file exists
    const res = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`,
      { method:'PUT', headers: GH_HEADERS(), body: JSON.stringify(body) }
    );
    if(!res.ok){
      const txt = await res.text();
      const err = new Error('PUT '+res.status+' '+txt);
      err.status = res.status;
      throw err;
    }
    return res.json();
  }

  const toB64 = str => btoa(unescape(encodeURIComponent(str)));
  const fromB64 = b => decodeURIComponent(escape(atob(b)));
  const pretty = obj => JSON.stringify(obj, null, 2);

  async function loadPreview(){
    try{
      saveLocals();
      statusEl.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©â€¦';
      const owner  = ownerInput.value.trim();
      const repo   = repoInput.value.trim();
      const path   = pathInput.value.trim();
      const branch = branchInput.value.trim();

      const file = await githubGetContents(owner, repo, path, branch);
      if(!file){ previewEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯.'; statusEl.textContent=''; return; }
      const json = JSON.parse(fromB64(file.content));
      previewEl.textContent = pretty(json);
      statusEl.textContent='';
    }catch(e){
      statusEl.textContent = 'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: '+e.message;
    }
  }

  async function save(){
    try{
      saveLocals();
      statusEl.textContent = 'â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦';

      const owner  = ownerInput.value.trim();
      const repo   = repoInput.value.trim();
      const path   = pathInput.value.trim();
      const branch = branchInput.value.trim();

      const payload = {
        title: titleInput.value.trim(),
        left:  leftInput.value.trim(),
        right: rightInput.value.trim(),
        updatedAt: new Date().toISOString()
      };

      // Always fetch latest SHA first
      let file = await githubGetContents(owner, repo, path, branch);
      let sha = file && file.sha ? file.sha : undefined;

      const bodyB64 = toB64(pretty(payload));

      // Try up to 5 times if GitHub returns 409 (stale SHA)
      const maxTries = 5;
      let attempt = 0;
      while(true){
        try{
          await githubPutContents(owner, repo, path, `update choices.json`, bodyB64, sha, branch);
          break; // success
        }catch(err){
          if(err.status === 409 && attempt < maxTries-1){
            // wait a bit, refetch latest SHA, and retry
            await new Promise(r => setTimeout(r, 500 + attempt*300));
            file = await githubGetContents(owner, repo, path, branch);
            sha = file && file.sha ? file.sha : undefined;
            attempt++;
            continue;
          }
          throw err;
        }
      }

      statusEl.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ â€” <span class="ok">choices.json</span> ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡';
      previewEl.textContent = pretty(payload);
    }catch(e){
      statusEl.innerHTML = 'âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+String(e.message).replace(/</g,'&lt;');
    }
  }

  $('saveBtn').addEventListener('click', save);
  $('loadBtn').addEventListener('click', loadPreview);
  loadPreview();
</script>
</body>
</html>
